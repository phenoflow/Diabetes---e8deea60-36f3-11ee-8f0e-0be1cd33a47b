# Kuan V, Denaxas S, Gonzalez-Izquierdo A, Direk K, Bhatti O, Husain S, Sutaria S, Hingorani M, Nitsch D, Parisinos C, Lumbers T, Mathur R, Sofat R, Casas JP, Wong I, Hemingway H, Hingorani A, 2023.

import sys, csv, re

codes = [{"code":"C108.12","system":"readv2"},{"code":"C108.13","system":"readv2"},{"code":"C109.12","system":"readv2"},{"code":"C109.13","system":"readv2"},{"code":"C10E.00","system":"readv2"},{"code":"C10E.11","system":"readv2"},{"code":"C10F.00","system":"readv2"},{"code":"C10F.11","system":"readv2"},{"code":"10418","system":"med"},{"code":"10692","system":"med"},{"code":"12455","system":"med"},{"code":"12640","system":"med"},{"code":"12736","system":"med"},{"code":"1407","system":"med"},{"code":"1549","system":"med"},{"code":"17545","system":"med"},{"code":"17858","system":"med"},{"code":"17859","system":"med"},{"code":"18143","system":"med"},{"code":"18209","system":"med"},{"code":"18219","system":"med"},{"code":"18230","system":"med"},{"code":"18264","system":"med"},{"code":"18278","system":"med"},{"code":"18387","system":"med"},{"code":"18390","system":"med"},{"code":"18425","system":"med"},{"code":"18496","system":"med"},{"code":"18642","system":"med"},{"code":"18683","system":"med"},{"code":"18777","system":"med"},{"code":"21983","system":"med"},{"code":"22871","system":"med"},{"code":"22884","system":"med"},{"code":"24423","system":"med"},{"code":"24458","system":"med"},{"code":"24836","system":"med"},{"code":"25591","system":"med"},{"code":"25627","system":"med"},{"code":"26054","system":"med"},{"code":"30294","system":"med"},{"code":"30323","system":"med"},{"code":"32627","system":"med"},{"code":"34268","system":"med"},{"code":"34450","system":"med"},{"code":"35288","system":"med"},{"code":"35385","system":"med"},{"code":"36633","system":"med"},{"code":"37806","system":"med"},{"code":"38161","system":"med"},{"code":"39070","system":"med"},{"code":"40682","system":"med"},{"code":"40837","system":"med"},{"code":"41049","system":"med"},{"code":"42729","system":"med"},{"code":"42762","system":"med"},{"code":"42831","system":"med"},{"code":"43227","system":"med"},{"code":"43921","system":"med"},{"code":"44779","system":"med"},{"code":"44982","system":"med"},{"code":"45913","system":"med"},{"code":"45914","system":"med"},{"code":"45919","system":"med"},{"code":"46150","system":"med"},{"code":"46301","system":"med"},{"code":"46850","system":"med"},{"code":"46917","system":"med"},{"code":"47315","system":"med"},{"code":"47321","system":"med"},{"code":"47409","system":"med"},{"code":"47582","system":"med"},{"code":"47649","system":"med"},{"code":"47650","system":"med"},{"code":"47816","system":"med"},{"code":"47954","system":"med"},{"code":"48192","system":"med"},{"code":"49074","system":"med"},{"code":"49146","system":"med"},{"code":"49554","system":"med"},{"code":"49655","system":"med"},{"code":"49869","system":"med"},{"code":"49949","system":"med"},{"code":"50225","system":"med"},{"code":"50527","system":"med"},{"code":"50813","system":"med"},{"code":"51756","system":"med"},{"code":"51957","system":"med"},{"code":"53392","system":"med"},{"code":"54008","system":"med"},{"code":"54899","system":"med"},{"code":"55075","system":"med"},{"code":"55239","system":"med"},{"code":"56268","system":"med"},{"code":"57278","system":"med"},{"code":"58604","system":"med"},{"code":"59253","system":"med"},{"code":"59725","system":"med"},{"code":"60107","system":"med"},{"code":"60208","system":"med"},{"code":"60699","system":"med"},{"code":"60796","system":"med"},{"code":"61071","system":"med"},{"code":"61344","system":"med"},{"code":"61829","system":"med"},{"code":"62107","system":"med"},{"code":"62209","system":"med"},{"code":"62352","system":"med"},{"code":"62613","system":"med"},{"code":"62674","system":"med"},{"code":"63017","system":"med"},{"code":"63690","system":"med"},{"code":"64571","system":"med"},{"code":"64668","system":"med"},{"code":"65267","system":"med"},{"code":"65704","system":"med"},{"code":"66145","system":"med"},{"code":"66872","system":"med"},{"code":"66965","system":"med"},{"code":"67905","system":"med"},{"code":"68105","system":"med"},{"code":"68390","system":"med"},{"code":"69676","system":"med"},{"code":"69993","system":"med"},{"code":"70316","system":"med"},{"code":"70766","system":"med"},{"code":"758","system":"med"},{"code":"85991","system":"med"},{"code":"91646","system":"med"},{"code":"91942","system":"med"},{"code":"91943","system":"med"},{"code":"93468","system":"med"},{"code":"93727","system":"med"},{"code":"93878","system":"med"},{"code":"95343","system":"med"},{"code":"95351","system":"med"},{"code":"95992","system":"med"},{"code":"96235","system":"med"},{"code":"97446","system":"med"},{"code":"97474","system":"med"},{"code":"97894","system":"med"},{"code":"98616","system":"med"},{"code":"98723","system":"med"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('diabetes-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["diabetes-mellitus---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["diabetes-mellitus---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["diabetes-mellitus---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
